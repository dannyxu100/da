/**daInput
*智能输入选择控件类
* @author danny.xu
* @version daInput_1.0 2011-8-14 9:10:25
*/
(function(j,k){var l=j.document;var m=(function(){var g=function(a){if(da.isFunction(a)||"string"===typeof a)return g.getInput(a);return new g.fnStruct.init(a)};g.fnStruct=g.prototype={version:"daInput v1.0 \n author: danny.xu \n date: 2011-8-14 9:10:54",iId:0,iObj:null,iParentObj:null,iTextObj:null,iIconObj:null,daGifObj:null,setting:{target:null,parent:null,id:"",width:"160px",height:"24px",style:"",className:"editbox",icon:"edit",isTextarea:false,isDisabled:"",isReadonly:"",source:"",onvalid:"",invalid:"",hoverColor:"#fffff0",css:{daInput:"daInput"},mousedown:null,mouseup:null,click:null,dblclick:null,keyup:null,change:null},init:function(a){a=this.setting=da.extend({},this.setting,a);this.iParentObj=da(a.parent);this.iParentObj=0<this.iParentObj.dom.length?this.iParentObj.dom[0]:l.body;if(a.id)this.iId=a.id;else while(null!==l.getElementById("daInput_"+this.iId))this.iId++;this.create();this.bindEvent();this.reSize();g.pushCache(this)},create:function(){var a=this.setting,id="daInput_"+this.iId,iObj,iTextObj,iIconObj;iObj=l.createElement("span");iObj.id=id;iObj.className=[a.css.daInput,a.className].join(" ");if(a.style)iObj.style.cssText=a.style;this.iParentObj.insertBefore(iObj,a.target);this.iObj=iObj;if(a.target&&a.target.nodeType){iObj.insertBefore(a.target);this.iTextObj=a.target}else{if(a.isTextarea)iTextObj=l.createElement("textarea");else iTextObj=l.createElement("input");iTextObj.id=a.id?a.id:id+"_text";if(a.isDisabled)iTextObj.setAttribute("disabled","disabled");if(a.isReadonly)iTextObj.setAttribute("readonly","readyonly");if(a.source)iTextObj.setAttribute("source",a.source);if(a.invalid)iTextObj.setAttribute("invalid",a.invalid);if(a.onvalid)iTextObj.setAttribute("onvalid",a.onvalid);iObj.insertBefore(iTextObj);this.iTextObj=iTextObj}if(!a.isTextarea){iIconObj=l.createElement("span");iIconObj.id=id+"_icon";iIconObj.className=a.icon;iIconObj.style.cssText="display:none";if(a.image)iIconObj.style.backgroundImage="url("+a.image+")";iObj.insertBefore(iIconObj);this.iIconObj=iIconObj}},bindEvent:function(){var f=this,setting=this.setting;if(!setting.isTextarea){da(this.iIconObj).bind("click",function(){if(da.isFunction(f.setting.click))f.setting.click.call(this);g.run[setting.icon](f,true)})}da(this.iObj).bind("dblclick",function(){if(da.isFunction(f.setting.dblclick))f.setting.dblclick.call(this);g.run[setting.icon](f,true)}).bind("click",function(){f.reSize();if(!f.setting.isDisabled){try{f.iTextObj.focus()}catch(e){}}});da(this.iTextObj).bind("focus click",function(a){a.stopPropagation();f.iconShow();if("list"===setting.icon||"date"===setting.icon)g.run[setting.icon](f,true)}).bind("blur",function(){f.iconHide();if("list"===setting.icon||"date"===setting.icon)f.TimerPadHide=da.timer(100,g.run[setting.icon],f,false)}).bind("change",function(){if(da.isFunction(f.setting.change))f.setting.change.call(this)});if("undefined"===typeof daKey)return;daKey({target:this.iTextObj,keydown:function(a,b,c,d){if(da.isFunction(setting.keyup))setting.keyup.call(f.iTextObj,a,b,c,d);switch(setting.icon){case"dialog":if("Enter"===a)g.run.dialog(f,true);break;case"list":if(!f.daListObj)break;if("Down Arrow"===a){f.daListObj.show();f.daListObj.next()}else if("Up Arrow"===a){f.daListObj.show();f.daListObj.prev()}else if("Enter"===a){var e=f.daListObj.get();if(e){f.iTextObj.value=e.text;f.iTextObj.setAttribute("code",e.value)}f.daListObj.hide()}break}}})},iconShow:function(){this.iObj.style.backgroundColor=this.setting.hoverColor;this.reSize();if(this.setting.isTextarea)return;if("undefined"!==typeof daFx){da(this.iIconObj).stop(true,true);if("undefined"!==typeof daGif){this.iIconObj.style.display="inline-block";if(this.daGifObj){this.daGifObj.play()}else{this.daGifObj=daGif({target:this.iIconObj,all:5,speed:15,top:g.IconTopHash[this.setting.icon],width:16,height:16})}}else{da(this.iIconObj).fadeIn(300)}}else this.iIconObj.style.display="block"},iconHide:function(){this.iObj.style.backgroundColor="";if(this.setting.isTextarea)return;if("undefined"!==typeof daFx){da(this.iIconObj).stop(true,true);if("undefined"!==typeof daGif){if(this.daGifObj)this.daGifObj.stop()}da(this.iIconObj).fadeOut(300)}else this.iIconObj.style.display="none"},reSize:function(){var a=this.setting,wText,hText;da(this.iObj).width(a.width);da(this.iObj).height(a.height);wText=da(this.iObj).width();if(a.isTextarea)da(this.iTextObj).width("100%");else da(this.iTextObj).width(wText-(a.isTextarea?2:22));da(this.iTextObj).height(a.height)}};g.fnStruct.init.prototype=g.prototype;g.IconTopHash={edit:"0px",dialog:"-16px",date:"-32px",list:"-48px"};g.daInputCache=[];g.pushCache=function(a){var b=g.daInputCache;b.push({id:a.sId,obj:a})};g.getInput=function(c){var d=g.daInputCache;if("string"===typeof c){c=c.replace("#","");for(var i=0,len=d.length;i<len;i++){if(c==d[i].id)return d[i].obj}return null}else if(da.isFunction(c)){da.each(d,function(a,b){return c.call(this.obj,this.id)});return d}};inlineEvents=["mousedown","mouseup","click","dblclick","keyup","change"];g.toInput=function(a){var b={},eventType="",style=a.style.cssText,w=da(a).css("width"),h=da(a).css("height");for(var n=0,len=inlineEvents.length;n<len;n++){eventType="on"+inlineEvents[n];if(da.isFunction(a[eventType]))b[inlineEvents[n]]=a[eventType]}var c={id:a.id,target:a,parent:a.parentNode,isTextarea:"TEXTAREA"===a.tagName};c=da.extend({},c,b);if(w&&"auto"!==w)c.width=w;if(h&&"auto"!==h)c.height=h;if(a.className)c.className=a.className;if(style)c.style=style;if(g.isSelect(a))c.icon="list";else if(g.isDate(a))c.icon="date";else if(g.isDialog(a))c.icon="dialog";else c.icon="edit";var d=g(c)};g.isDialog=function(a){var b=a.getAttribute("source");return b?true:false};g.isDate=function(a){var b=a.getAttribute("onvalid");return b&&0<=b.indexOf("isdate")?true:false};g.isSelect=function(a){var b=a.getAttribute("source");return b&&0<=b.indexOf("auto_code")?true:false};g.run={edit:function(){},list:function(b,c){if(b.daListObj){c?b.daListObj.show():b.daListObj.hide()}else if(c){if("undefined"===typeof daList)return;b.daListObj=daList({target:b.iObj,width:da(b.iObj).width(),click:function(a){b.iTextObj.value=a.text;b.iTextObj.setAttribute("code",a.value);b.iTextObj.select();this.hide()}});g.getListSource(b.iTextObj.getAttribute("source"),function(a){b.daListObj.setList(a)})}},date:function(b,c){var d=b.iTextObj.getAttribute("onvalid")||b.iTextObj.getAttribute("source");if(0>d.indexOf("isdate("))return;if(b.daCalendarObj){c?b.daCalendarObj.show():b.daCalendarObj.hide()}else if(c){b.daCalendarObj=daCalendar({target:b.iObj,isSelector:true,cellEvent:{"click":function(a){b.iTextObj.value=b.daCalendarObj.getDate(this).date.format("yyyy-MM-dd");b.iTextObj.select();b.daCalendarObj.hide()}},clickToday:function(){b.iTextObj.value=(new Date()).format("yyyy-MM-dd");b.iTextObj.select();b.daCalendarObj.hide()},clickPrev:function(){if(b.TimerPadHide)da.clearTimer(b.TimerPadHide);b.daCalendarObj.show()},clickNext:function(){if(b.TimerPadHide)da.clearTimer(b.TimerPadHide);b.daCalendarObj.show()},clickRefresh:function(){}})}},dialog:function(a){var b=a.iTextObj.getAttribute("source")||a.iTextObj.getAttribute("onvalid");if(b){b=b.replace(/\(this/g,"( arguments[0]");b=new Function(b);b(a.iTextObj)}}};return g})();j.daInput=m;da(function(){da("input:text,textarea").each(function(a,b){m.toInput(this)})})})(window);daInput.getListSource=function(e,f){if(!e)return;da.ajax({url:"/sys/aspx/execsql.aspx?sqlname="+e+"&xml=1",type:'GET',error:function(a,b,c){},success:function(a,b,c){var d=da.xml2json(a).ds1;if(d){a={};for(var i=0,len=d.length;i<len;i++){a[d[i].bc_name]=d[i].bc_name1}f(a)}}})};